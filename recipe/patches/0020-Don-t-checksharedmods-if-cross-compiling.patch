From 512dd160fb94c23a16753e0cd7dd7720782cebf6 Mon Sep 17 00:00:00 2001
From: "Uwe L. Korn" <uwe.korn@quantco.com>
Date: Fri, 1 Sep 2023 23:32:14 +0200
Subject: [PATCH 20/26] Don't checksharedmods if cross-compiling

---
 Makefile.pre.in |  2 +-
 if_runnable.sh  | 10 ++++++++++
 2 files changed, 11 insertions(+), 1 deletion(-)
 create mode 100755 if_runnable.sh

diff --git a/Makefile.pre.in b/Makefile.pre.in
index a8207acf889..0e694d378cb 100644
--- a/Makefile.pre.in
+++ b/Makefile.pre.in
@@ -1609,7 +1609,7 @@ checksharedmods: sharedmods $(PYTHON_FOR_BUILD_DEPS) $(BUILDPYTHON)
 	else \
 		$(RUNSHARED) $(PYTHON_FOR_BUILD) $(srcdir)/Tools/build/check_extension_modules.py --generate-missing-stdlib-info; \
 	fi
-	@$(RUNSHARED) $(PYTHON_FOR_BUILD) $(srcdir)/Tools/build/check_extension_modules.py
+	@$(RUNSHARED) $(srcdir)/if_runnable.sh $(PYTHON_FOR_BUILD) $(srcdir)/Tools/build/check_extension_modules.py
 
 .PHONY: rundsymutil
 rundsymutil: sharedmods $(PYTHON_FOR_BUILD_DEPS) $(BUILDPYTHON)
diff --git a/if_runnable.sh b/if_runnable.sh
new file mode 100755
index 00000000000..dcfde5b751e
--- /dev/null
+++ b/if_runnable.sh
@@ -0,0 +1,10 @@
+#!/bin/bash
+
+if [[ "${target_platform}" == "${build_platform}" || "${CROSSCOMPILING_EMULATOR:-}" != "" ]]; then
+  if [[ "$1" == "./"* ]]; then
+    exec $@
+  else
+    export ${@:1:$#-2}
+    exec ${@: -2}
+  fi
+fi
